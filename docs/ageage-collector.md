# アゲアゲスクレイピングスクリプト設計ドキュメント

## 概要

このドキュメントでは、沖縄県内の飲食店情報を「アゲアゲ」サイトからスクレイピングし、データベースに格納するためのNode.jsアプリケーションの設計について説明します。

## 目的

Webサイト「アゲアゲ」から沖縄県内の飲食店情報を定期的に収集し、構造化されたデータとしてデータベースに保存することが目的です。このデータは後続のアプリケーションで活用されます。

## 技術スタック

- **言語・ランタイム**: Node.js、TypeScript
- **スクレイピング**: Cheerio (jQuery風のDOM操作ライブラリ)
- **HTTPクライアント**: Node.js 組み込みの fetch API
- **データベース**: PostgreSQL (Prismaを使用したORM)
- **実行環境**: Cloud Run Jobs
- **依存関係管理**: pnpm

## アーキテクチャ

### ディレクトリ構成

```
apps/backend/
└── src/
    └── scripts/
        └── ageage-collector/
            ├── index.ts              # エントリーポイント
            ├── scraper.ts            # スクレイピングロジック
            ├── geocoder.ts           # 地理情報コーディングロジック
            ├── repository.ts         # データベース操作ロジック
            └── utils.ts              # ユーティリティ関数
```

### 主要モジュール

1. **index.ts**: スクリプトのエントリーポイント。引数の解析やメインロジックの実行を行います。
2. **scraper.ts**: Webサイトからデータを抽出するロジック。Node.js の fetch API を使用してHTTPリクエストを行い、Cheerioでパースします。
3. **geocoder.ts**: 住所から緯度・経度を取得するロジック。これも Node.js fetch API を使用します。
4. **repository.ts**: Prisma を使用してデータベースとの通信を行うモジュール。MeshiとMunicipalityの作成・更新・取得を担当します。
5. **utils.ts**: 共通のユーティリティ関数。

## データフロー

1. スクリプト実行
2. ターゲットページのスクレイピング（fetch APIを使用）
3. 記事リストの抽出（Cheerioでパース）
4. 各記事の詳細ページからデータ抽出
5. 住所から緯度・経度の取得
6. 郵便番号または住所から自治体情報の取得
7. Prismaを使用してデータベースへの保存（Meshi、Municipalityモデル）

## データモデル

スクレイピングで取得するデータは、Prismaのスキーマで定義されているモデルに合わせます：

1. **Meshi**:
   - articleId: 記事の一意のID
   - title: 記事のタイトル
   - imageUrl: 店舗画像のURL
   - storeName: 店舗名
   - address: 住所
   - siteUrl: 記事のURL
   - publishedDate: 公開日
   - latitude: 緯度
   - longitude: 経度
   - municipalityId: 自治体ID（外部キー）

2. **Municipality**:
   - name: 自治体名
   - zipcode: 郵便番号（オプション）

## エラーハンドリング

- スクレイピング中のネットワークエラー
- 地理情報API呼び出し時のエラー
- データベース操作時のエラー
- パターンマッチングの失敗

各エラーをログに記録し、可能な場合は処理を継続します。

## 実行モード

- **単一ページモード**: 最初のページのみスクレイピング
- **全ページモード**: すべてのページをスクレイピング

## Cloud Run Jobs設定

Cloud Run Jobsで定期実行するための設定を含みます。環境変数でデータベース接続情報を提供します。

## パフォーマンス考慮事項

- サイトへの負荷を軽減するためのリクエスト間隔制御
- 同時実行数の制限
- キャッシュ戦略

## 今後の拡張性

- 他の情報源からのデータ収集追加
- データ検証の強化
- 通知機能の実装 